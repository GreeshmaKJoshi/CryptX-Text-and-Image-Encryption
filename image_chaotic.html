<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chaotic Logistic Map Image Encryption</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: url('https://images.unsplash.com/photo-1521811628991-7a3ea581f7d1?w=1200') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
    }

    .container {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      flex-wrap: wrap;
      margin: 20px;
    }

    .panel {
      background-color: rgba(0,0,0,0.6);
      border-radius: 12px;
      padding: 20px;
      margin: 10px;
      width: 300px;
    }

    input[type="file"], input[type="number"] {
      width: 80%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 5px;
      border: none;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    canvas {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    .extras {
      margin: 30px;
    }

    .extras button {
      background-color: #222;
    }

    #theory, #animation {
      background-color: rgba(255, 255, 255, 0.1);
      color: rgb(15, 15, 15);
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      margin-top: 20px;
      border-radius: 12px;
      display: none;
      text-align: left;
    }
  </style>
</head>
<body>

<h1>üîê Chaotic Logistic Map Image Encryption</h1>

<div class="container">
  <div class="panel">
    <input type="file" id="imageInput" accept="image/*">
    <br>
    <input type="number" id="x0" step="0.01" placeholder="Initial x (e.g. 0.5)">
    <input type="number" id="r" step="0.01" placeholder="Parameter r (e.g. 3.9)">
    <br>
    <button onclick="encryptImage()">Encrypt</button>
    <button onclick="decryptImage()">Decrypt</button>
    <p><strong>Original</strong></p>
    <canvas id="originalCanvas"></canvas>
  </div>

  <div class="panel">
    <p><strong>Encrypted</strong></p>
    <canvas id="encryptedCanvas"></canvas>
  </div>

  <div class="panel">
    <p><strong>Decrypted</strong></p>
    <canvas id="decryptedCanvas"></canvas>
  </div>
</div>

<div class="extras">
  <button onclick="toggleSection('theory')">Show Theory</button>
  <button onclick="showAnimation()">Show Animation</button>
</div>

<div id="theory">
  <h2>üìò Theory - Chaotic Logistic Map</h2>
  <p>The logistic map is a simple mathematical formula that generates a chaotic sequence:
    <code>X‚Çô‚Çä‚ÇÅ = r √ó X‚Çô √ó (1 - X‚Çô)</code>, where <code>r</code> is the parameter and <code>X‚ÇÄ</code> is the initial condition.</p>
  <p>In this encryption system:</p>
  <ul>
    <li>The image's pixel positions are permuted based on a sequence generated by the logistic map.</li>
    <li>During encryption, the sequence is used to shuffle pixels.</li>
    <li>During decryption, the exact sequence (with same x‚ÇÄ and r) is regenerated to reverse the permutation.</li>
  </ul>
</div>

<div id="animation">
  <h2>üéÆ Animation</h2>
  <canvas id="animatedCanvas"></canvas>
</div>

<script>
  let originalPixels = null;
  let width = 0, height = 0;

  function toggleSection(id) {
    document.getElementById('theory').style.display = 'none';
    document.getElementById('animation').style.display = 'none';
    document.getElementById(id).style.display = 'block';
  }

  document.getElementById("imageInput").addEventListener("change", function () {
    const reader = new FileReader();
    reader.onload = function (e) {
      const img = new Image();
      img.onload = function () {
        width = img.width;
        height = img.height;

        const canvas = document.getElementById("originalCanvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        originalPixels = ctx.getImageData(0, 0, width, height);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(this.files[0]);
  });

  function generateLogisticMap(length, x0, r) {
    let x = x0;
    const seq = [];
    for (let i = 0; i < length; i++) {
      x = r * x * (1 - x);
      seq.push(x);
    }
    return seq;
  }

  function getPermutation(seq) {
    const indices = seq.map((_, i) => i);
    return indices.sort((a, b) => seq[a] - seq[b]);
  }

  function getInversePermutation(perm) {
    const inv = [];
    for (let i = 0; i < perm.length; i++) {
      inv[perm[i]] = i;
    }
    return inv;
  }

  function applyPermutation(imageData, perm) {
    const newPixels = new Uint8ClampedArray(imageData.data.length);
    for (let i = 0; i < perm.length; i++) {
      const from = perm[i];
      for (let j = 0; j < 4; j++) {
        newPixels[i * 4 + j] = imageData.data[from * 4 + j];
      }
    }
    return new ImageData(newPixels, width, height);
  }

  function encryptImage() {
    const x0 = parseFloat(document.getElementById("x0").value);
    const r = parseFloat(document.getElementById("r").value);
    if (isNaN(x0) || isNaN(r)) return alert("Enter valid x0 and r");

    const totalPixels = width * height;
    const seq = generateLogisticMap(totalPixels, x0, r);
    const perm = getPermutation(seq);

    const encrypted = applyPermutation(originalPixels, perm);

    const canvas = document.getElementById("encryptedCanvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.putImageData(encrypted, 0, 0);
  }

  function decryptImage() {
    const x0 = parseFloat(document.getElementById("x0").value);
    const r = parseFloat(document.getElementById("r").value);
    if (isNaN(x0) || isNaN(r)) return alert("Enter valid x0 and r");

    const totalPixels = width * height;
    const seq = generateLogisticMap(totalPixels, x0, r);
    const perm = getPermutation(seq);
    const inversePerm = getInversePermutation(perm);

    const canvas = document.getElementById("encryptedCanvas");
    const ctx = canvas.getContext("2d");
    const encryptedData = ctx.getImageData(0, 0, width, height);

    const decrypted = applyPermutation(encryptedData, inversePerm);

    const dCanvas = document.getElementById("decryptedCanvas");
    dCanvas.width = width;
    dCanvas.height = height;
    const dCtx = dCanvas.getContext("2d");
    dCtx.putImageData(decrypted, 0, 0);
  }

  function showAnimation() {
    const canvas = document.getElementById("animatedCanvas");
    if (!originalPixels || !width || !height) {
      alert("Please upload an image first and encrypt it.");
      return;
    }

    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");

    const x0 = parseFloat(document.getElementById("x0").value);
    const r = parseFloat(document.getElementById("r").value);

    if (isNaN(x0) || isNaN(r)) {
      alert("Please provide valid x0 and r values.");
      return;
    }

    const totalPixels = width * height;
    const seq = generateLogisticMap(totalPixels, x0, r);
    const perm = getPermutation(seq);
    const inversePerm = getInversePermutation(perm);

    const currentPixels = new Uint8ClampedArray(originalPixels.data);
    const tempEncrypted = new Uint8ClampedArray(originalPixels.data.length);
    const tempDecrypted = new Uint8ClampedArray(originalPixels.data.length);

    let frame = 0;
    const totalFrames = 20;
    const chunkSize = Math.ceil(totalPixels / totalFrames);

    function animateToEncrypted() {
      const start = frame * chunkSize;
      const end = Math.min((frame + 1) * chunkSize, totalPixels);

      for (let i = start; i < end; i++) {
        const from = perm[i];
        for (let j = 0; j < 4; j++) {
          tempEncrypted[i * 4 + j] = originalPixels.data[from * 4 + j];
        }
      }

      ctx.putImageData(new ImageData(tempEncrypted, width, height), 0, 0);
      frame++;

      if (frame < totalFrames) {
        requestAnimationFrame(animateToEncrypted);
      } else {
        setTimeout(() => {
          frame = 0;
          animateToDecrypted();
        }, 1000);
      }
    }

    function animateToDecrypted() {
      const start = frame * chunkSize;
      const end = Math.min((frame + 1) * chunkSize, totalPixels);

      for (let i = start; i < end; i++) {
        const from = inversePerm[i];
        for (let j = 0; j < 4; j++) {
          tempDecrypted[i * 4 + j] = tempEncrypted[from * 4 + j];
        }
      }

      ctx.putImageData(new ImageData(tempDecrypted, width, height), 0, 0);
      frame++;

      if (frame < totalFrames) {
        requestAnimationFrame(animateToDecrypted);
      }
    }

    toggleSection('animation');
    animateToEncrypted();
  }
</script>

</body>
</html>
